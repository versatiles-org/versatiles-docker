name: Build a single Docker image

on:
  workflow_dispatch:
    inputs:
      name:
        description: "Which image?"
        default: "versatiles"
        type: choice
        options:
          - versatiles
          - versatiles-frontend
          - versatiles-tilemaker
          - versatiles-tippecanoe
  workflow_call:
    inputs:
      name:
        description: "Which image?"
        default: "versatiles"
        type: string

env:
  CARGO_TERM_COLOR: always
  FORCE_COLOR: 1

jobs:
  build:
    name: Building ${{ inputs.name }}
    runs-on: macos-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Multi-arch support
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      # Log in to Docker Hub
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build + test + push
      - name: Build script
        run: bash ./${{ inputs.name }}/build.sh --test --push
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          