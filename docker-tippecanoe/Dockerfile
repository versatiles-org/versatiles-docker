# syntax=docker/dockerfile:1

###############################################################################
# ‚õèÔ∏è  Builder stage                                                             #
###############################################################################

ARG TIPPECANOE_VERSION=v2.34.0

FROM alpine:3.20 AS builder
ARG TIPPECANOE_VERSION

# Build dependencies
RUN apk add --no-cache --virtual .build-deps \
    git \
    make \
    g++ \
    sqlite-dev \
    zlib-dev

WORKDIR /src

# Shallow‚Äëclone the requested tag for reproducible builds
RUN git clone --depth 1 --branch "${TIPPECANOE_VERSION}" https://github.com/felt/tippecanoe.git .

# Compile (binaries are produced in /src)
RUN make -j"$(nproc)"

###############################################################################
# üöÄ Runtime stage                                                             #
###############################################################################

FROM alpine:3.20

# Copy the compiled binaries only (keeps image small)
COPY --from=builder /src/tippecanoe /src/tippecanoe-json-tool /src/tippecanoe-decode /src/tile-join /usr/local/bin/

# Minimal runtime libs
RUN apk add --no-cache libstdc++ sqlite-libs zlib

WORKDIR /data
ENTRYPOINT ["tippecanoe"]
